#include "stm8l15x.h"
#include "OLED.h"
#include "8x16.h"
#include "config.h"

//D0
#define     SCLK_Set()        GPIO_SetBits(OLED_SCLK_PORT , OLED_SCLK_PIN)
#define     SCLK_Reset()      GPIO_ResetBits(OLED_SCLK_PORT , OLED_SCLK_PIN)
//D1
#define     SDIN_Set()        GPIO_SetBits(OLED_MOSI_PORT , OLED_MOSI_PIN)
#define     SDIN_Reset()      GPIO_ResetBits(OLED_MOSI_PORT , OLED_MOSI_PIN)

#define     RES_Set()         GPIO_SetBits(OLED_RST_PORT , OLED_RST_PIN)
#define     RES_Reset()       GPIO_ResetBits(OLED_RST_PORT , OLED_RST_PIN)

#define     DC_Set()          GPIO_SetBits(OLED_DC_PORT , OLED_DC_PIN)
#define     DC_Reset()        GPIO_ResetBits(OLED_DC_PORT , OLED_DC_PIN)

#define     CS_Set()          GPIO_SetBits(OLED_CS_PORT , OLED_CS_PIN)
#define     CS_Reset()        GPIO_ResetBits(OLED_CS_PORT , OLED_CS_PIN)

// display buffer
// Aviod using the page 0 and put this in .bss section
// Addressing Mode: Page addressing Mode
// bmp to c code generator: 
// https://colab.research.google.com/drive/1PTJfVU06FB1QQls97KjYByCGWBHHfQkQ#scrollTo=0CywFKduRgft
// Need to request tho ;)
// Need to resize manually to 128x64 in pixel

// Relace SPIWrite with the platform specific SPI fucntion to operate

@near uint8_t gui_disp_buf[X_WIDTH * Y_WIDTH / 8]=
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF0,0xE0,0xC0,0xC0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,
0x0C,0xFE,0xFE,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0x80,0x80,0x80,0x80,0x80,0xC0,0xC0,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x60,0x70,0x70,0x70,0x60,0xC0,0x80,0x80,0xE0,0x80,0x00,0x00,0x00,
0x00,0x80,0x00,0x00,0x80,0x80,0xF0,0x3F,0x0F,0x0F,0x03,0x01,0x00,0x00,0x00,0xC0,
0xE0,0xE0,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x1F,0x3F,0x1F,0x1E,0x1E,0x1E,
0xFE,0xFF,0xFF,0x3E,0x3C,0x3C,0x3C,0xFE,0xFE,0xFF,0x10,0x00,0x00,0x00,0x00,0xC2,
0x01,0x01,0x01,0x01,0x01,0x03,0x03,0x03,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x81,0x0F,0x07,0x07,0x00,0x00,0x00,
0x00,0x07,0x03,0x01,0x01,0x81,0x01,0x20,0x20,0x20,0xC0,0xC0,0xC0,0x80,0x00,0x00,
0x01,0x07,0x3F,0xFF,0xFC,0xF8,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,
0xFF,0x7F,0x0F,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xF0,0xC0,0x00,0x00,0x00,0x07,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x1C,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x02,0x07,0x07,0x07,0x07,0x0F,0x0F,0x0E,0x00,0x00,0x00,0x00,
0x78,0x78,0x00,0x00,0x00,0x01,0x00,0x10,0x70,0xF0,0xFF,0x01,0x00,0x00,0x00,0x00,
0x00,0x00,0xF8,0xFF,0x7F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
0x01,0x00,0x00,0x00,0x00,0xE0,0xF0,0x7F,0x7F,0x7F,0x7F,0x3F,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x18,0x38,0xF8,0xF8,0x78,0x38,0x0C,0x04,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x20,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0x00,0x01,0x03,
0x03,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};


unsigned char SPIWrite(uint8_t TxData)
{
	// Use the specific SPI function for particular hardware platform
	SPI_SendData(SPI1 , TxData);
}

void SPI_Port_Init()
{
    CLK_PeripheralClockConfig(CLK_Peripheral_SPI1 , ENABLE);
   
    SPI_Init(SPI1,
             SPI_FirstBit_MSB,
             SPI_BaudRatePrescaler_2,
             SPI_Mode_Master,
             SPI_CPOL_Low,
             SPI_CPHA_1Edge,
             SPI_Direction_1Line_Tx,
             SPI_NSS_Soft,
             0
             );
    
    SPI_NSSInternalSoftwareCmd(SPI1 , ENABLE);
    SPI_Cmd(SPI1 , ENABLE);
		
		// Dummy byte, from original library
		// No use
    //SPIWrite(0xff); 
}

void OLED_Port_Init()
{
	// Hardware specific code
	
  //CSK
  GPIO_Init(OLED_SCLK_PORT , OLED_SCLK_PIN , GPIO_Mode_Out_PP_High_Fast);  
  //MOSI
  GPIO_Init(OLED_MOSI_PORT , OLED_MOSI_PIN , GPIO_Mode_Out_PP_High_Fast);  
  
  //OLED RES
  GPIO_Init(OLED_RST_PORT , OLED_RST_PIN , GPIO_Mode_Out_PP_High_Fast);  
  //OLED DC
  GPIO_Init(OLED_DC_PORT , OLED_DC_PIN , GPIO_Mode_Out_PP_High_Fast);  
  //OLED CS
  GPIO_Init(OLED_CS_PORT , OLED_CS_PIN , GPIO_Mode_Out_PP_High_Fast);  
  
	SPI_Port_Init();
}

void OLED_WriteCommond(uint8_t commond)
{
	// Refer to data sheet of SSD1306
	// DC HIGH to Command mode
	// CS LOW to SPI select
  DC_Reset();
  CS_Reset();
  SPIWrite(commond);
  CS_Set();
  DC_Set();
}

void OLED_WriteData(uint8_t dat)
{
	// Refer to data sheet of SSD1306
	// DC LOW to Data transfer Mode
	// CS LOW to SPI select
  DC_Set();
  CS_Reset();
  SPIWrite(dat);
  CS_Set();
  DC_Set();
}

void OLED_Set_Pos(uint8_t page, uint8_t col) 
{ 
  OLED_WriteCommond(0xb0 + (page & 0b111)); // Set pages, y from 0-7
  OLED_WriteCommond(((col & 0xf0)>> 4) | 0x10); // Set high nibble for col addressing
  OLED_WriteCommond(( col & 0x0f)); // Set low nibble for col addressing
}   	

void OLED_Display_On(void)
{
  OLED_WriteCommond(0x8d);	// Charge pump setting
  OLED_WriteCommond(0x14);	// enable charge pump
  OLED_WriteCommond(0xaf);	// display on
}
 
void OLED_Display_Off(void)
{
  OLED_WriteCommond(0x8d);	// Charge pump setting
  OLED_WriteCommond(0x10);	// disable charge pump
  OLED_WriteCommond(0xae);	// display off
}	

void OLED_Clear(void)  
{  
  uint8_t  i , n;		    
  for(i = 0; i < 8 ;i++)  
  {  
    OLED_Set_Pos(i,0);
    for(n = 0; n < 128 ; n++)
     OLED_WriteData(0x00);
  }
}

void OLED_DrawWindow(void)  
{  
  uint16_t j;
  uint8_t  i , n;		
  
  j = 0;
  for(i = 0; i < 8 ;i++)  // 8 pages
  {  
		// Refer to SSD1306 Section 10.1.3 for Page addressing mode referenceh
    OLED_WriteCommond(0xb0 + i);  // Set page address
    OLED_WriteCommond(0x00);      // Set lower 4 bit for Col address (0000[4:0])
    OLED_WriteCommond(0x10);      // Set higher 4 bit for Col address (0001[4:0])
		// Start col 0b0000 0000 = Seg 0
		
    for(n = 0; n < 128 ; n++)
		{ // 128 byte for each row // each byte for each row
      OLED_WriteData(gui_disp_buf[j++]);
		}
			//Col pointer increase by 1 after writing to the particular GDDRAM
			//index j also increase by 1 from the settings
  }
}

void OLED_ClearBuf()
{
  uint16_t i;
  for(i = 0; i < (X_WIDTH * Y_WIDTH / 8) ; i++)
  {
    gui_disp_buf[i] = 0x00;
  }
}

void OLED_Reset()
{
	/* Old Reset
  RES_Set();
  delay(100);
  RES_Reset();
  delay(100);
  RES_Set();
	*/
	
  RES_Reset();
  RES_Set();
  
  OLED_WriteCommond(0xae); // Display off command
	
  OLED_WriteCommond(0x20); // Set memory addressing mode
  OLED_WriteCommond(0x02); // Set as Page addressing mode
  
  OLED_WriteCommond(0x00); // Set colume address lower nibble
  OLED_WriteCommond(0x10); // Set colume address high nibble
  
  OLED_WriteCommond(0x40); // display start ram mapping to 0
	
  OLED_WriteCommond(0x81); // set contrast control
  OLED_WriteCommond(0xff); // set contrast value
  
  OLED_WriteCommond(0xa8); // set MUX ratio
  OLED_WriteCommond(0x3f); // 64MUX
	
  OLED_WriteCommond(0xa1); // Segement remap (mirror:0xA0 or not:0xA1)
	
  OLED_WriteCommond(0xc8); // Set com output scan direction, depends on hardware layout
	
  OLED_WriteCommond(0xda); // Set com pin hardware mapping
  OLED_WriteCommond(0x12); 

  OLED_WriteCommond(0xd3); // Set vertical display offset
  OLED_WriteCommond(0x00); 
  
  OLED_WriteCommond(0xd5); // Set display clock
  OLED_WriteCommond(0x80); // can set to a higher rate for more frequent gif?
  
  OLED_WriteCommond(0xd9); // Set precharge period
  OLED_WriteCommond(0xf1);
  
  OLED_WriteCommond(0xdb); // Set logic level
  OLED_WriteCommond(0x40);

  OLED_WriteCommond(0x8d); // Set charge pump setting
  OLED_WriteCommond(0x14);
	
  OLED_WriteCommond(0xa4); // Display on following GDDRAM
	
  OLED_WriteCommond(0xa6); // Set normal display
	
  OLED_WriteCommond(0xaf); // Display on
  
  OLED_Clear();
  OLED_Set_Pos(0 , 0);

}

void OLED_ClearPage(uint8_t page)
{
	uint8_t n = 0;
	// Refer to SSD1306 Section 10.1.3 for Page addressing mode referenceh
	OLED_WriteCommond(0xb0 + page);  // Set page address
	OLED_WriteCommond(0x00);      // Set lower 4 bit for Col address (0000[4:0])
	OLED_WriteCommond(0x10);      // Set higher 4 bit for Col address (0001[4:0])
	// Start col 0b0000 0000 = Seg 0
		
	for(n = 0; n < 128 ; n++)
	{ // 128 byte for each row // each byte for each row
		OLED_WriteData(0);
	}
}

void OLED_showChar_6x8(uint8_t chr)
{
	uint8_t i = 0;
	for(i=0;i<6;i++)
	{
		OLED_WriteData(font6x8[chr][i]); // Offset from font to ascii table
	}

}